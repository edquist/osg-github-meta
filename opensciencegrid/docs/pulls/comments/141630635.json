{
  "_links": {
    "html": {
      "href": "https://github.com/opensciencegrid/docs/pull/182#discussion_r141630635"
    }, 
    "pull_request": {
      "href": "https://api.github.com/repos/opensciencegrid/docs/pulls/182"
    }, 
    "self": {
      "href": "https://api.github.com/repos/opensciencegrid/docs/pulls/comments/141630635"
    }
  }, 
  "author_association": "OWNER", 
  "body": "The squid doc has been converted already, fix the link", 
  "commit_id": "537e0b49923a2cdfd6b706bd4203a97d8293c19b", 
  "created_at": "2017-09-28T14:16:12Z", 
  "diff_hunk": "@@ -0,0 +1,338 @@\n+\n+Install a CVMFS Stratum 1\n+===================================================================\n+\n+# About this Document \n+This document describes how to install a CVMFS Stratum 1. There are many different variations on how to do that, but this document focuses on the configuration of the OSG GOC Stratum 1 oasis-replica.opensciencegrid.org. It is applicable to other Stratum 1s as well, very likely with modifications (some of which are suggested in the document below).\n+\n+# Applicable versions \n+The applicable software versions for this document are cvmfs and cvmfs-server >= 2.2.1.\n+\n+# Requirements\n+\n+## Host and OS\n+\n+-   OS is a 64-bit <span class=\"twiki-macro SUPPORTED_OS\"></span>.\n+-   Root access\n+-   SELinux disabled\n+-   Adequate disk space for the repositories that will be served, at `/srv/cvmfs`. Do not use xfs as the filesystem type on operating systems older than RHEL7, because it has been demonstrated to perform poorly for CVMFS repositories; instead use ext3 or ext4. About 10GB should be reserved for apache and squid logs under /var/log on a production server, although they normally will not get that large. A Stratum 1 that is also a repository server should have at least 5GB available at `/var/cache`.\n+\n+## Users and Groups\n+\n+If your machine is also going to be a repository server like the OSG GOC, the installation will create one user unless it already exists:\n+\n+<span class=\"twiki-macro STARTSECTION\">Users</span>\n+\n+| User    | Comment                   |\n+|:--------|:--------------------------|\n+| `cvmfs` | CernVM-FS service account |\n+\n+<span class=\"twiki-macro ENDSECTION\">Users</span>\n+\n+A repository server installation will also create a cvmfs group and default the cvmfs user to that group.\n+\n+In addition, if the fuse rpm is not for some reason already installed, installing the repository server packages will also install fuse and that will create another group:\n+\n+<span class=\"twiki-macro STARTSECTION\">Groups</span>\n+\n+| Group   | Comment                   | Group members |\n+|:--------|:--------------------------|:--------------|\n+| `cvmfs` | CernVM-FS service account | none          |\n+| `fuse`  | FUSE service account      | `cvmfs`       |\n+\n+<span class=\"twiki-macro ENDSECTION\">Groups</span>\n+\n+# Install Instructions\n+\n+All CVMFS Stratum 1s require cvmfs-server software and apache (httpd). It is highly recommended to also install frontier-squid and frontier-awstats on the same machine to be able to easily join the WLCG [MRTG](http://wlcg-squid-monitor.cern.ch/snmpstats/indexcvmfs.html) and [awstats](http://wlcg-squid-monitor.cern.ch/awstats/cvmfs.html) monitoring systems. The recommended configuration for frontier-squid below does not do any caching, it is just for monitoring.\n+\n+## Installing cvmfs-server and httpd\n+\n+The OSG GOC Stratum 1 has to function as a repository server in addition to serving repository replications; most Stratum 1s serve only replications. Serving repositories is done quite differently on Redhat EL5 and EL6 systems. Instructions are also provided for how to install cvmfs-server on Stratum 1s that do not have to be repository servers, which is the same on both versions of operating systems. Choose one of the following three sections.\n+\n+### Installing a CVMFS repository server\n+\n+#### Installing CVMFS repository server on RHEL5\n+\n+Redhat EL5-based systems that are not Scientific Linux-based should first build the [SL5 aufs source rpm](http://ftp.scientificlinux.org/linux/scientific/5x/SRPMS/SL/aufs-0.20090202.cvs-6.sl5.src.rpm) and install the resulting rpm in their own yum repository.\n+\n+Follow these instructions to install:\n+\n+```\n+[root@client ~] $ rpm -i http://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs/EL/5/x86_64/cvmfs-release-2-4.el5.noarch.rpm\n+[root@client ~] $ rpm -Uvh http://dl.fedoraproject.org/pub/epel/5/i386/epel-release-5-4.noarch.rpm\n+[root@client ~] $ yum -y install aufs cvmfs-server.x86_64 cvmfs.x86_64 mod_wsgi\n+```\n+\n+#### Installing CVMFS repository server on RHEL6\n+\n+Redhat EL6-based systems running a CVMFS repository server have to get their kernel from CERN: \n+\n+```\n+[root@client ~] $ rpm -i http://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs-release-latest.noarch.rpm\n+[root@client ~] $ yum -y install --enablerepo=cernvm-kernel kernel aufs2-util cvmfs-server.x86_64 cvmfs.x86_64 mod_wsgi\n+[root@client ~] $ reboot\n+```\n+\n+#### CVMFS repository server and RHEL7 \n+RHEL7.2 cannot be reliably used as a repository server, because of bugs in the union filesystem OverlayFS. The bugs are fixed in RHEL7.3.\n+\n+Redhat EL7.3-based systems running a CVMFS repository server is the simplest method: \n+\n+```\n+[root@client ~] $ rpm -i http://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs-release-latest.noarch.rpm\n+[root@client ~] $ yum -y install cvmfs-server.x86_64 cvmfs.x86_64 mod_wsgi\n+```\n+\n+### Installing CVMFS stratum 1 code without repository server code \n+If you're not installing for the OSG GOC or otherwise want to support serving repositories on the same machine as a Stratum 1, use this section.\n+\n+On Redhat EL5, first do these commands:\n+\n+```\n+[root@client ~] $ curl -O https://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs/EL/5/x86_64/cvmfs-release-2-4.el5.noarch.rpm\n+[root@client ~] $ rpm -i cvmfs-release-2-4.el5.noarch.rpm \n+[root@client ~] $ curl -O https://dl.fedoraproject.org/pub/epel/epel-release-latest-5.noarch.rpm\n+[root@client ~] $ rpm -Uvh epel-release-latest-5.noarch.rpm\n+```\n+\n+On Redhat EL6, first do these commands:\n+\n+```\n+[root@client ~] $ rpm -i https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm\n+```\n+\n+\n+On Redhat EL7, first do these commands:\n+\n+```\n+[root@client ~] $ rpm -i https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm\n+```\n+\n+Then on any type of system do this command:\n+\n+```\n+[root@client ~] $ yum -y install cvmfs-server.x86_64 cvmfs-config mod_wsgi\n+```\n+\n+## Installing frontier-squid and frontier-awstats\n+\n+Do these commands to install frontier-squid and frontier-awstats:\n+\n+```\n+[root@client ~] $ rpm -i http://frontier.cern.ch/dist/rpms/RPMS/noarch/frontier-release-1.1-1.noarch.rpm\n+[root@client ~] $ yum -y install frontier-awstats\n+```\n+\n+# Configuring\n+\n+## Configuring the system\n+\n+Increase the default number of open file descriptors:\n+\n+```\n+[root@client ~] $ echo -e \"\\*\\t\\t-\\tnofile\\t\\t16384\" >>/etc/security/limits.conf \n+[root@client ~] $ ulimit -n 16384\n+```\n+\n+In order for this to apply also interactively when logging in over ssh, the option `UsePAM` has to be set to `yes` in `/etc/ssh/sshd_config`.\n+\n+## Configuring cron \n+First, create the log directory: \n+\n+```\n+[root@client ~] $ mkdir -p /var/log/cvmfs\n+```\n+\n+Put the following in `/etc/cron.d/cvmfs`:\n+\n+```\n+0,15,30,45 * * * * root test -d /srv/cvmfs || exit;cvmfs_server snapshot -ai \n+0 9 * * * root find /srv/cvmfs/\\*.**/data/txn -name \"**.*\" -mtime +2 2>/dev/null|xargs rm -f\n+```\n+\n+\n+Also put the following in `/etc/logrotate.d/cvmfs`:\n+\n+```\n+/var/log/cvmfs/\\*.log { weekly missingok notifempty }\n+```\n+\n+## Configuring apache\n+\n+If you are installing frontier-squid, create `/etc/httpd/conf.d/cvmfs.conf` and put the following lines into it:\n+\n+```\n+Listen 8080 KeepAlive On\n+```\n+\n+If you are not installing frontier-squid, instead put the following lines into that file:\n+\n+```\n+Listen 8000 KeepAlive On\n+```\n+\n+If you will be serving opensciencegrid.org repositories, you have to allow for old client configurations that access repositories without the domain name added. For that reason, you will need to remove each `/etc/httpd/conf.d/cvmfs.<repositoryname>.conf` that adding a replica creates (this is included in the [add_osg_repository script](http://svn.usatlas.bnl.gov/svn/oasis/oasis-server/trunk/bin/add_osg_repository)), and instead add the following to `/etc/httpd/conf.d/cvmfs.conf`:\n+\n+```\n+RewriteEngine On \n+RewriteRule ^/cvmfs/(\\[^./\\]**)/(.**)$ /cvmfs/$1.opensciencegrid.org/$2 \n+RewriteRule ^/cvmfs/(\\[^/\\]+)/api/(.**)$ /cvmfs/$1/api/$2 \\[PT\\] \n+RewriteRule ^/cvmfs/(.**)$ /srv/cvmfs/$1 \n+<Directory \"/srv/cvmfs\"> \n+  Options -MultiViews +FollowSymLinks -Indexes \n+  AllowOverride All \n+  Order allow,deny \n+  Allow from all\n+\n+  EnableMMAP Off EnableSendFile Off\n+\n+  <FilesMatch \"^\\.cvmfs\"> ForceType application/x-cvmfs </FilesMatch>\n+\n+  Header unset \n+  Last-Modified \n+  FileETag None\n+\n+  ExpiresActive On \n+  ExpiresDefault \"access plus 3 days\" \n+  ExpiresByType text/html \"access plus 15 minutes\" \n+  ExpiresByType application/x-cvmfs \"access plus 2 minutes\" \n+</Directory>\n+\n+WSGIDaemonProcess cvmfs-api processes=2 display-name=%{GROUP} \\\\ python-path=/usr/share/cvmfs-server/webapi \n+WSGIProcessGroup cvmfs-api \n+WSGISocketPrefix /var/run/wsgi \n+WSGIScriptAliasMatch /cvmfs/(\\[^/\\]+)/api /var/www/wsgi-scripts/cvmfs-api.wsgi/$1 \n+```\n+\n+On EL7-based systems (apache httpd 2.4 and later) replace the \"Order allow, deny\" and \"Allow from all\" to \"Require all granted\".\n+\n+If you will be serving cern.ch repositories, it has the same problem; replace opensciencegrid.org above with cern.ch. If you need to serve both opensciencegrid.org and cern.ch contact Dave Dykstra to discuss the options.\n+\n+Then enable apache:\n+\n+```\n+[root@client ~] $ chkconfig httpd on \n+[root@client ~] $ service httpd start\n+```\n+\n+## Configuring frontier-squid\n+\n+Put the following in `/etc/squid/customize.sh` after the existing comment header:\n+\n+```\n+awk --file `dirname $0`/customhelps.awk --source '{\n+\n+# cache only api calls \n+insertline(\"^http_access deny all\", \"acl CVMFSAPI urlpath_regex ^/cvmfs/\\[^/\\]\\*/api/\") insertline(\"^http_access deny all\", \"cache deny CVMFSAPI\")\n+\n+# port 80 is also supported, through an iptables redirect \n+setoption(\"http_port\", \"8000 accel defaultsite=localhost:8080 no-vhost\") setoption(\"cache_peer\", \"localhost parent 8080 0 no-query originserver\")\n+\n+# allow incoming http accesses from anywhere \\# all requests will be forwarded to the originserver \n+commentout(\"http_access allow NET_LOCAL\") insertline(\"^http_access deny all\", \"http_access allow all\")\n+\n+# do not let squid cache DNS entries more than 5 minutes \n+setoption(\"positive_dns_ttl\", \"5 minutes\")\n+\n+# set shutdown_lifetime to 0 to avoid giving new connections error \\# codes, which get cached upstream \n+setoption(\"shutdown_lifetime\", \"0 seconds\")\n+\n+# turn off collapsed_forwarding to prevent slow clients from slowing down faster ones\n+setoption(\"collapsed_forwarding\", \"off\")\n+\n+print }'\n+```\n+\n+\n+On an RHEL7 system, make sure that iptables-services is installed and enabled:\n+\n+```\n+[root@client ~] $ yum -y install iptables-services \n+[root@client ~] $ systemctl enable iptables\n+```\n+\n+Forward port 80 to port 8000 (first command is for external, second command for localhost):\n+\n+```\n+[root@client ~] $ iptables -t nat -A PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8000 \n+[root@client ~] $ iptables -t nat -A OUTPUT -o lo -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8000 \n+[root@client ~] $ service iptables save\n+```\n+\n+On RHEL7 also set up the the same port forwarding for IPv6 (unfortunately it is not supported on RHEL6):\n+\n+```\n+[root@client ~] $ ip6tables -t nat -A PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8000\n+[root@client ~] $ ip6tables -t nat -A OUTPUT -o lo -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8000\n+[root@client ~] $ service ip6tables save\n+```\n+\n+\n+Enable frontier-squid:\n+\n+```\n+[root@client ~] $ chkconfig frontier-squid on\n+[root@client ~] $ service frontier-squid start\n+```\n+\n+Note: the above configuration is for a single squid thread, which is fine for 1Gbit/s and possibly 2Gbit/s, but if higher bandwidth is needed, see the [instructions for running multiple squid workers](https://twiki.cern.ch/twiki/bin/view/Frontier/InstallSquid#Running_multiple_squid_workers).", 
  "html_url": "https://github.com/opensciencegrid/docs/pull/182#discussion_r141630635", 
  "id": 141630635, 
  "original_commit_id": "a19dde48e1fd23b836d6f1d92bf6e119846746aa", 
  "original_position": 279, 
  "path": "docs/other/install-cvmfs-stratum1.md", 
  "position": null, 
  "pull_request_review_id": 65873387, 
  "pull_request_url": "https://api.github.com/repos/opensciencegrid/docs/pulls/182", 
  "updated_at": "2017-09-28T16:54:05Z", 
  "url": "https://api.github.com/repos/opensciencegrid/docs/pulls/comments/141630635", 
  "user": {
    "avatar_url": "https://avatars3.githubusercontent.com/u/390105?v=4", 
    "events_url": "https://api.github.com/users/brianhlin/events{/privacy}", 
    "followers_url": "https://api.github.com/users/brianhlin/followers", 
    "following_url": "https://api.github.com/users/brianhlin/following{/other_user}", 
    "gists_url": "https://api.github.com/users/brianhlin/gists{/gist_id}", 
    "gravatar_id": "", 
    "html_url": "https://github.com/brianhlin", 
    "id": 390105, 
    "login": "brianhlin", 
    "organizations_url": "https://api.github.com/users/brianhlin/orgs", 
    "received_events_url": "https://api.github.com/users/brianhlin/received_events", 
    "repos_url": "https://api.github.com/users/brianhlin/repos", 
    "site_admin": false, 
    "starred_url": "https://api.github.com/users/brianhlin/starred{/owner}{/repo}", 
    "subscriptions_url": "https://api.github.com/users/brianhlin/subscriptions", 
    "type": "User", 
    "url": "https://api.github.com/users/brianhlin"
  }
}
