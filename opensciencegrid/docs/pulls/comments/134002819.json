{
  "_links": {
    "html": {
      "href": "https://github.com/opensciencegrid/docs/pull/18#discussion_r134002819"
    }, 
    "pull_request": {
      "href": "https://api.github.com/repos/opensciencegrid/docs/pulls/18"
    }, 
    "self": {
      "href": "https://api.github.com/repos/opensciencegrid/docs/pulls/comments/134002819"
    }
  }, 
  "author_association": "OWNER", 
  "body": "Have we dropped `gratia-xrootd-storage`? If so, you should remove the reference to it on line 342. Also, `start` should be `stop`.", 
  "commit_id": "ab67ed825290196df4ed01ddf648feed7f07e5ba", 
  "created_at": "2017-08-18T16:39:35Z", 
  "diff_hunk": "@@ -0,0 +1,500 @@\n+Installing BeStMan\n+==================\n+\n+!!! warning\n+    As of the June 2017 release of OSG 3.4.0, this software is officially deprecated.  Support is scheduled to end as of June 2018.\n+\n+About this Document\n+====================\n+\n+This document explains how to install a BeStMan SRMv2 service. This procedure will guide one through the installation and configuration of a basic `bestman2` host with an underlying GridFTP server. This will allow the service to service requests via the SRM (Storage Resource Manager) protocol or the GridFTP protocol.\n+\n+Installing BeStMan Storage Element\n+==================================\n+\n+This procedure explains how to install the stand-alone BeStMan Storage Element server; [see below](#upgrading-bestman) for notes on upgrading.  The service has the following components:\n+\n+-   BeStMan - provides load-balancing across GridFTP servers.\n+-   GridFTP server - provides file transfer services using the GridFTP protocol.\n+-   [Gratia gridftp transfer probe](https://twiki.opensciencegrid.org/bin/view/Documentation/Release3/GratiaTransferProbe) (optional) - provides transfer accounting information to the OSG.\n+\n+Requirements\n+------------\n+\n+### Host and OS\n+\n+- You need at least one node in order to install this service.\n+- The OS must be in the [supported platforms](../release/supported_platforms.md) list.\n+- The [OSG software repositories](../common/yum.md) must be configured correctly.\n+- All procedures in this document require *root* privileges.\n+\n+### Users\n+\n+This installation will create following users unless they are already created:\n+\n+| User      | Comment                                         |\n+|:----------|:------------------------------------------------|\n+| `bestman` | Used by Bestman SRM server                      |\n+\n+For full functionality, the `bestman` account will need limited `sudo` access to a few commands, described below.\n+\n+For this package to function correctly, you will have to create the users needed for grid operation. Any user that can be authenticated should be created.  For grid-mapfile users, each line of the grid-mapfile is a certificate/user pair. Each user in this file should be created on the server. For GUMS sites, this means that each user that can be authenticated by GUMS should be created on the server.\n+\n+Note that these users must be kept in sync with the authentication method. For instance, if new users or rules are added in GUMS, then new users should also be added here.\n+\n+### Certificates\n+\n+Two certificates are needed for operation of this service.\n+\n+| Certificate                 | User that owns certificate | Path to certificate                                                                                 |\n+|:----------------------------|:---------------------------|:----------------------------------------------------------------------------------------------------|\n+| Host certificate            | `root`                     | `/etc/grid-security/hostcert.pem` and `/etc/grid-security/hostkey.pem`                       |\n+| Bestman service certificate | `bestman`                  | `/etc/grid-security/bestman/bestmancert.pem` and `/etc/grid-security/bestman/bestmankey.pem` |\n+\n+Following the [instructions](https://twiki.opensciencegrid.org/bin/view/Documentation/Release3/OSGPKICommandlineClients) to request a service certificate.\n+\n+You will also need a copy of CA certificates. Note that the `osg-se-bestman` package will automatically install a certificate package but will not necessarily pick the cert package you expect; see [the CA certificates](../common/ca.md) documentation for more information.\n+\n+### Networking\n+\n+For more details on overall firewall configuration, please see our [firewall documentation](https://twiki.opensciencegrid.org/bin/view/Documentation/Release3/FirewallInformation).\n+\n+| Service Name            | Protocol | Port Number               | Inbound | Outbound | Comment                                 |\n+|:------------------------|:---------|:--------------------------|:--------|:---------|:----------------------------------------|\n+| GridFTP data channels   | tcp      | `GLOBUS_TCP_PORT_RANGE`   | X       |          | contiguous range of ports is necessary. |\n+| GridFTP data channels   | tcp      | `GLOBUS_TCP_SOURCE_RANGE` |         | X        | contiguous range of ports is necessary. |\n+| GridFTP control channel | tcp      | 2811                      | X       |          |                                         |\n+| SRM                     | tcp      | 8443                      | X       |          |                                         |\n+\n+### Engineering Considerations\n+\n+Please answer following questions before you proceed with installation and configuration of BeStMan storage element:\n+\n+Q. *What authorization mechanism should I use?*\n+\n+Decide between a [grid-mapfile](https://twiki.grid.iu.edu/bin/view/Documentation/Release3/Edg-mkgridmap) or a [GUMS](https://twiki.grid.iu.edu/bin/view/Documentation/Release3/InstallGums) server for authorization.  Both mechanisms are deprecated with a planned removal by June 2018.  The replacement mechanism, however, does not work with `bestman2`.\n+\n+Q. *How many GridFTP servers will I need?*\n+\n+Choose to run multiple GridFTP servers for load balancing and better performance. We recommend to install additional GridFTP servers if your Storage Element:\n+\n+* Is serving data to more than 1000 cores for VOs that use storage heavily (e.g. CMS, ATLAS, CDF, and D0),\n+* Is managing more than 500 TB of disk space, OR\n+* Has more than 10Gbps bandwidth\n+\n+We recommend approximately one GridFTP server for each 8Gbps of desired utilized bandwidth.\n+\n+Q. *Do I need to change default configuration of Gridftp server?*\n+\n+Yes, you may want to do this if the node on which GridFTP server will be installed has multiple network interfaces. Read [this section](https://twiki.grid.iu.edu/bin/view/Documentation/Release3/InstallOSGGridFTP#ConfigMultiHomed) for more details.\n+\n+Q. *Do you need to enable Gratia gridftp-transfer probes?*   \n+The Gratia gridftp-transfer probes provide OSG storage statistics for accounting purposes. The reports include the source and destination of transfers, certificate subject of transfer initiator, as well as the size and status of the transferred file. The probe needs to be installed on every GridFTP server.\n+\n+Install Instructions\n+====================\n+\n+Installing BeStMan2\n+-------------------\n+\n+1.  Install Java using [these instructions](https://twiki.grid.iu.edu/bin/view/Documentation/Release3/InstallSoftwareWithOpenJDK7#InstallingJava).\n+2.  Install the BeStMan Storage element meta-package:\n+\n+```console\n+[root@client ~] # yum install osg-se-bestman\n+```\n+\n+Authorization\n+-------------\n+\n+There are two authorization options:\n+\n+* Gridmap file\n+* GUMS authentication server\n+\n+Please choose one of these and follow the instructions in one of the two following sections.\n+\n+### Configuring Gridmap Support\n+\n+By default, GridFTP uses a gridmap file, found in `/etc/grid-security/grid-mapfile`. This file is not generated by default. can generate this file. You can generate this file manually, by including DN/username combinations (this is most useful for debugging). Otherwise, you can use [`edg-mkgridmap`](https://twiki.grid.iu.edu/bin/view/Documentation/Release3/Edg-mkgridmap), which will periodically contact a list of VOMS servers that you specify.\n+\n+Once `edg-mkgridmap` is configured, you will have to modify `/etc/bestman2/conf/bestman2.rc` and change `GridMapFileName` from `/etc/bestman2/conf/grid-mapfile.empty` to:\n+```text\n+GridMapFileName=/etc/grid-security/grid-mapfile\n+```\n+\n+In `/etc/sysconfig/bestman2`, change\n+```bash\n+BESTMAN_GUMS_ENABLED=no\n+```\n+\n+### Configuring GUMS support\n+\n+By default, GridFTP uses a gridmap file, found in `/etc/grid-security/gridmap-file`. If you want to use GUMS security (recommended), you will need to enable it using the following steps.\n+\n+First, edit `/etc/grid-security/gsi-authz.conf` and uncomment the authorization callout:\n+\n+```\n+globus_mapping liblcas_lcmaps_gt4_mapping.so lcmaps_callout\n+```\n+\n+Next edit `/etc/lcmaps.db` to enter the correct GUMS hostname:\n+\n+```\n+gumsclient = \"lcmaps_gums_client.mod\"\n+             \"-resourcetype ce\"\n+             \"-actiontype execute-now\"\n+             \"-capath /etc/grid-security/certificates\"\n+             \"-cert   /etc/grid-security/hostcert.pem\"\n+             \"-key    /etc/grid-security/hostkey.pem\"\n+             \"--cert-owner root\"\n+# Change this URL to your GUMS server\n+             \"--endpoint https://<GUMS_HOSTNAME>:8443/gums/services/GUMSXACMLAuthorizationServicePort\"\n+```\n+\n+You will need to modify the following settings in `/etc/sysconfig/bestman2`\n+\n+```bash\n+BESTMAN_GUMSCERTPATH=/etc/grid-security/bestman/bestmancert.pem\n+BESTMAN_GUMSKEYPATH=/etc/grid-security/bestman/bestmankey.pem\n+```\n+\n+You will need to modify the following settings in `/etc/bestman2/conf/bestman2.rc`\n+\n+```text\n+GUMSserviceURL=https://<GUMS_HOST>:8443/gums/services/GUMSXACMLAuthorizationServicePort\n+```\n+\n+Edit Bestman Settings\n+---------------------\n+\n+Bestman settings are split into three files:\n+\n+- Environment variables (except those that represent server and client libraries) are stored in `/etc/sysconfig/bestman2`.\n+- The server and client library environment variables are stored in `/etc/sysconfig/bestman2lib`.\n+- Configuration is stored in `/etc/bestman2/conf/bestman2.rc`.\n+\n+You should review these settings to make sure all of them comply with your environment. You are not expected to edit `/etc/sysconfig/bestman2lib` .\n+\n+!!! note\n+    If you are upgrading from a version prior to 2.3.0-9, you will need to remove **all** entries for `BESTMAN2_SERVER_LIB` and `BESTMAN2_CLIENT_LIB` in file `/etc/sysconfig/bestman2.` These settings are now present in file `/etc/sysconfig/bestman2lib`\n+\n+You will likely need to modify the following settings in `/etc/bestman2/conf/bestman2.rc`:\n+\n+```text\n+localPathListAllowed=/tmp\n+CertFileName=/etc/grid-security/bestman/bestmancert.pem\n+KeyFileName=/etc/grid-security/bestman/bestmankey.pem\n+supportedProtocolList=gsiftp://<GRIDFTP_HOSTNAME>;gsiftp://<GRIDFTP_HOSTNAME2>\n+```\n+\n+!!! note\n+    Make sure the value for `localPathListAllowed` is correctly entered - i.e. each path separated by a `;`. If it is not, this parameter may not be effective.\n+    Make sure the permissions for the `localPathListAllowed` directory(ies) are set to 1777, which is the default for `/tmp`. Further, note that on many systems, `/tmp` gets cleared out automatically, so you may want to use a different location to ensure that the files persist.\n+\n+BeStMan requires up to two sets of certificate pairs. One is for host services; when clients connect to BeStMan, they will receive this certificate (`CertFileName`, `KeyFileName`) as proof of the server identity. The second certificate pair (`BESTMAN_GUMSCERTPATH`, `BESTMAN_GUMSKEYPATH`) is used to communicate with GUMS when verifying identity information (this only applicable for GUMS-enabled sites). These two can (and usually will be) the same files, but can be split if your GUMS setup requires a specific identity.\n+\n+`localPathListAllowed` determines which paths users will be able to access via SRM.\n+\n+`supportedProtocolList` is a semi-colon list of GridFTP servers that the BeStMan will use as transfer agents. If you are using anything but the standard GridFTP port 2811, you will also have to add the port (ie `gsiftp://<HOSTNAME>:port`).\n+\n+Finally, modify `GUMSserviceURL` to use your local GUMS installation if you are using GUMS.\n+\n+Modify `/etc/sudoers`\n+---------------------\n+\n+BeStman requires the `sudo` command in order to write information as the proper user. You will need to give the `bestman` user the proper permissions to run these commands.\n+\n+Modify `/etc/sudoers` and comment the following line.\n+\n+```text\n+#Defaults    requiretty\n+```\n+\n+Then add the following lines at the end of the `/etc/sudoers` file.\n+\n+```text\n+Cmnd_Alias SRM_CMD = /bin/rm, /bin/mkdir, /bin/rmdir, /bin/mv, /bin/cp, /bin/ls\n+Runas_Alias SRM_USR = ALL, !root\n+bestman   ALL=(SRM_USR) NOPASSWD: SRM_CMD\n+```\n+\n+Copying certificates to an alternate location\n+---------------------------------------------\n+\n+BeStMan requires a certificate pair to function; this must be readable by the `bestman` user.\n+\n+```console\n+[root@client ~] # cp /etc/grid-security/hostkey.pem /etc/grid-security/bestman/bestmankey.pem\n+[root@client ~] # cp /etc/grid-security/hostcert.pem /etc/grid-security/bestman/bestmancert.pem\n+[root@client ~] # chown -R bestman:bestman /etc/grid-security/bestman/\n+```\n+\n+Verify `CertFileName` and `KeyFileName` in `/etc/bestman2/conf/bestman2.rc` are set appropriately.\n+\n+(Optional) Using a different bestman user\n+---------------------------------------------\n+\n+If you would like to use a different user than the default `bestman` user (*not recommended*), you will need to change the following:\n+\n+-   Ownership of bestman certs in `/etc/grid-security/bestman`.\n+-   `SRM_OWNER` in `/etc/sysconfig/bestman2` to the new user.\n+-   User in `/etc/sudoers`. The last line (`bestman ALL(SRM_USR) NOPASSWD: SRM_CMD`) should be changed from `bestman` to the new user.\n+-   Ownership of `/var/log/bestman2`\n+\n+!!! warning\n+    Currently the RPM packaging will change the ownership of the `/var/log/bestman2` directory back to `bestman` on upgrades.\n+\n+(Optional) Modifying default logging for `event.srm.log`\n+--------------------------------------------------------\n+\n+The logging directory (`/var/log/bestman2`) has two types of logs - `bestman2.log` and `event.srm.log`.\n+\n+Log-rotation of `bestman2.log` file is controlled by `/etc/logrotate.d/bestman2` file.\n+\n+By default, the size of `event.srm.log` log file is set to 50MB within the Bestman code itself.\n+\n+Left unchanged, `event.srm.log` file counts will keep increasing indefinitely.  Depending on the usage, the number of these files can become high enough to fill up the partition that holds these logs.\n+\n+There are 3 ways to avoid this -\n+\n+-   Modify following parameters (commented by default) in the `/etc/sysconfig/bestman2` file\n+\n+        :::shell\n+        # Number of files to keep\n+        BESTMAN_EVENT_LOG_COUNT=10\n+        # Size of each file in bytes\n+        BESTMAN_EVENT_LOG_SIZE=20971520\n+\n+    The optimal value for these depends on usage of the service.\n+\n+- Create a directory under a much bigger partition and have a symlink from `/var/log/bestman2` to that directory.\n+- Leave the default settings, but have your own custom script that cleans these files according to your needs.\n+\n+Starting Services\n+=================\n+\n+1. `fetch-crl`\n+\n+    For RHEL 6:\n+\n+        :::console\n+        [root@client ~] # /usr/sbin/fetch-crl   # This fetches the CRLs \n+        [root@client ~] # /sbin/service fetch-crl-boot start\n+        [root@client ~] # /sbin/service fetch-crl-cron start\n+\n+    For RHEL 7:\n+\n+        :::console\n+        [root@client ~] # /usr/sbin/fetch-crl   # This fetches the CRLs \n+        [root@client ~] # systemctl start fetch-crl-boot\n+        [root@client ~] # systemctl start fetch-crl-cron\n+\n+2. GridFTP\n+\n+        :::console\n+        [root@client ~] # service globus-gridftp-server start\n+\n+3. Bestman\n+\n+        :::console\n+        [root@client ~] # service bestman2 start\n+\n+    To start Bestman automatically at boot time\n+\n+        :::console\n+        [root@client ~] # chkconfig bestman2 on\n+\n+4. Gratia transfer and storage probes\n+\n+        :::console\n+        [root@client ~] # service gratia-gridftp-transfer start\n+\n+Stopping Services\n+=================\n+\n+1. fetch-crl\n+\n+    For RHEL 6:\n+\n+        :::console\n+        [root@client ~] # /usr/sbin/fetch-crl   # This fetches the CRLs\n+        [root@client ~] # /sbin/service fetch-crl-boot start\n+        [root@client ~] # /sbin/service fetch-crl-cron start\n+\n+    For RHEL 7:\n+\n+        :::console\n+        [root@client ~] # /usr/sbin/fetch-crl   # This fetches the CRLs\n+        [root@client ~] # systemctl start fetch-crl-boot\n+        [root@client ~] # systemctl start fetch-crl-cron\n+\n+2. GridFTP\n+\n+        :::console\n+        [root@client ~] # service globus-gridftp-server stop\n+\n+3. Bestman\n+\n+        :::console\n+        [root@client ~] # service bestman2 stop\n+\n+4. Gratia transfer and storage probes\n+\n+        :::console\n+        [root@client ~] # service gratia-gridftp-transfer start", 
  "html_url": "https://github.com/opensciencegrid/docs/pull/18#discussion_r134002819", 
  "id": 134002819, 
  "original_commit_id": "ed6a913483c799a9de72a83d7d54d5143bed7531", 
  "original_position": 345, 
  "path": "docs/storage/bestman-install.md", 
  "position": null, 
  "pull_request_review_id": 57251861, 
  "pull_request_url": "https://api.github.com/repos/opensciencegrid/docs/pulls/18", 
  "updated_at": "2017-08-18T18:10:06Z", 
  "url": "https://api.github.com/repos/opensciencegrid/docs/pulls/comments/134002819", 
  "user": {
    "avatar_url": "https://avatars0.githubusercontent.com/u/5246893?v=4", 
    "events_url": "https://api.github.com/users/matyasselmeci/events{/privacy}", 
    "followers_url": "https://api.github.com/users/matyasselmeci/followers", 
    "following_url": "https://api.github.com/users/matyasselmeci/following{/other_user}", 
    "gists_url": "https://api.github.com/users/matyasselmeci/gists{/gist_id}", 
    "gravatar_id": "", 
    "html_url": "https://github.com/matyasselmeci", 
    "id": 5246893, 
    "login": "matyasselmeci", 
    "organizations_url": "https://api.github.com/users/matyasselmeci/orgs", 
    "received_events_url": "https://api.github.com/users/matyasselmeci/received_events", 
    "repos_url": "https://api.github.com/users/matyasselmeci/repos", 
    "site_admin": false, 
    "starred_url": "https://api.github.com/users/matyasselmeci/starred{/owner}{/repo}", 
    "subscriptions_url": "https://api.github.com/users/matyasselmeci/subscriptions", 
    "type": "User", 
    "url": "https://api.github.com/users/matyasselmeci"
  }
}
